<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>📧 템플릿 관리</title>
    <style>
        body { font-family: "Malgun Gothic", sans-serif; padding: 20px; background-color: #f6f7fb; }
        .manager-container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; }
        .template-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; background-color: #fff; }
        .template-item label { font-weight: bold; display: block; margin-top: 8px; }
        .template-item input, .template-item textarea { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
        .template-item textarea { height: 100px; resize: vertical; }
        .action-buttons { margin-top: 10px; text-align: right; }
        .action-buttons button { padding: 8px 15px; margin-left: 5px; cursor: pointer; border: none; border-radius: 5px; }
        .save { background-color: #007bff; color: white; }
        .delete { background-color: #dc3545; color: white; }
        .add-new { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; margin-top: 20px; cursor: pointer; }
        .info-box { background-color: #ffc; border: 1px solid #ff0; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="manager-container">
        <h2>템플릿 관리</h2>
        <div class="info-box">
            메일 문안에는 **{n}** (받는 분 성함), **{t}** (작품명), **{d}** (컨펌 요청일), **{signature}** (유소정 드림) 변수를 사용할 수 있습니다. 줄바꿈은 Enter키를 이용해 입력하시면 됩니다.
        </div>
        
        <div id="templatesList">
            </div>

        <button class="add-new" onclick="addNewTemplate()">➕ 새 템플릿 추가</button>
    </div>

    <script>
        const templatesList = document.getElementById('templatesList');
        const storageKey = 'emailTemplates';

        // 템플릿 기본값 (메인 창과 일치해야 함)
        const DEFAULT_TEMPLATES = {
            "sns": { name: "① SNS 포스팅 컨펌 요청", text: "{n}님 안녕하세요.\\n카카오엔터테인먼트 유소정입니다.\\n\\n귀사 {t} 작품의 타파스 SNS 포스팅을 희망하여 연락드립니다.\\n상세 내용은 아래 표를 통해 확인 부탁드리며,\\n관련하여 궁금하신 사항은 언제든 편히 연락 부탁드립니다.\\n\\n{d}\\n\\n감사합니다.\\n{signature}" },
            "discount": { name: "② 할인이벤트 컨펌 요청", text: "{n}님 안녕하세요,\\n카카오엔터테인먼트 유소정입니다.\\n\\n타파스에서 다가오는 <00월 진행 예정인> 할인이벤트에\\n귀사 {t} 작품의 참여를 제안드리고자 연락드립니다.\\n상세 내용은 아래 표를 통해 확인 부탁드리며,\\n관련하여 궁금하신 사항은 언제든 편히 연락 부탁드립니다.\\n\\n{d}\\n\\n감사합니다.\\n{signature}" },
            "viewing": { name: "③ 열람이벤트 에셋 컨펌 요청", text: "{n}님 안녕하세요,\\n카카오엔터테인먼트 유소정입니다.\\n\\n귀사 {t} 작품의 타파스 열람이벤트 진행을 희망하여 연락드립니다.\\n아래 표와 첨부파일을 통해 상세 내용과 이벤트 에셋 전달드리오니 확인을 부탁드리며,\\n검토 과정에서 문의사항 있으시면 언제든 편히 연락 주시기 바랍니다.\\n\\n{d}\\n\\n감사합니다.\\n{signature}" }
        };

        function loadTemplates() {
            let templates = JSON.parse(localStorage.getItem(storageKey));
            
            if (!templates) {
                templates = DEFAULT_TEMPLATES;
                saveTemplates(templates);
            }
            renderTemplates(templates);
        }

        function saveTemplates(templates) {
            localStorage.setItem(storageKey, JSON.stringify(templates));
            // 메인 창에 포커스를 주어 변경사항 반영을 요청
            if (window.opener) {
                 window.opener.focus();
            }
        }

        function renderTemplates(templates) {
            templatesList.innerHTML = '';
            for (const key in templates) {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.innerHTML = `
                    <label>ID (고유 키):</label>
                    <input type="text" value="${key}" disabled>
                    <label>표시 이름:</label>
                    <input type="text" id="name-${key}" value="${templates[key].name}">
                    <label>메일 문안:</label>
                    <textarea id="text-${key}">${templates[key].text.replace(/\\n/g, '\n')}</textarea>
                    <div class="action-buttons">
                        <button class="save" onclick="saveTemplate('${key}')">저장</button>
                        <button class="delete" onclick="deleteTemplate('${key}')">삭제</button>
                    </div>
                `;
                templatesList.appendChild(item);
            }
        }

        function saveTemplate(key) {
            const templates = JSON.parse(localStorage.getItem(storageKey));
            const newName = document.getElementById(`name-${key}`).value;
            // textarea의 실제 줄바꿈을 저장용 '\\n' 문자열로 변환
            const newText = document.getElementById(`text-${key}`).value.replace(/\n/g, '\\n'); 

            if (!newName || !newText) {
                alert("이름과 문안을 모두 입력해주세요.");
                return;
            }

            templates[key] = { name: newName, text: newText };
            saveTemplates(templates);
            loadTemplates();
            alert("템플릿이 저장되었습니다. 메인 창에 반영됩니다.");
        }

        function deleteTemplate(key) {
            if (!confirm(`'${key}' 템플릿을 정말로 삭제하시겠습니까?`)) return;
            
            const templates = JSON.parse(localStorage.getItem(storageKey));
            delete templates[key];
            saveTemplates(templates);
            loadTemplates();
            alert("템플릿이 삭제되었습니다. 메인 창에 반영됩니다.");
        }

        function addNewTemplate() {
            const templates = JSON.parse(localStorage.getItem(storageKey));
            let newKey = prompt("새 템플릿의 고유 ID (영어 소문자, 숫자)를 입력해주세요:").trim();
            
            if (!newKey) return;
            newKey = newKey.toLowerCase().replace(/[^a-z0-9]/g, ""); 

            if (!newKey || templates[newKey]) {
                alert("유효하지 않거나 이미 존재하는 ID입니다. 다른 ID를 입력해주세요.");
                return;
            }
            
            templates[newKey] = { name: "새 템플릿 (이름 변경 필요)", text: "{n}님 안녕하세요.\\n[여기에 템플릿 내용을 입력하세요]\\n\\n감사합니다.\\n{signature}" };
            saveTemplates(templates);
            loadTemplates();
        }

        loadTemplates();
    </script>
</body>
</html>